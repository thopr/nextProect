{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nvar __jsx = React.createElement;\nimport React, { createContext, useState, useContext, useEffect } from \"react\";\nimport Cookies from \"js-cookie\";\nimport Router, { useRouter } from \"next/router\"; //api here is an axios instance\n\nimport api from \"../services/Api\";\nvar AuthContext = createContext({});\nexport var AuthProvider = function AuthProvider(_ref) {\n  var _ref5;\n\n  var children = _ref.children;\n\n  var _useState = useState(null),\n      user = _useState[0],\n      setUser = _useState[1];\n\n  var _useState2 = useState(true),\n      loading = _useState2[0],\n      setLoading = _useState2[1];\n\n  var _useState3 = useState(true),\n      toggler = _useState3[0],\n      settoggler = _useState3[1];\n\n  useEffect(function () {\n    function loadUserFromCookies() {\n      return _loadUserFromCookies.apply(this, arguments);\n    }\n\n    function _loadUserFromCookies() {\n      _loadUserFromCookies = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var data, token;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                data = false;\n                token = Cookies.get(\"token\");\n\n                if (!token) {\n                  _context.next = 8;\n                  break;\n                }\n\n                console.log(\"Got a token in the cookies, let's see if it is valid\");\n                api.defaults.headers.Authorization = \"Bearer \".concat(token);\n                _context.next = 7;\n                return api.post(\"jwt-auth/v1/token/validate\").then(function (res) {\n                  data = res;\n                })[\"catch\"](function (err) {\n                  Cookies.remove(\"token\");\n                  Cookies.remove(\"user_nicename\");\n                  Cookies.remove(\"user_email\");\n                  Cookies.remove(\"UserType\");\n                  Cookies.remove(\"BracnhCode\");\n                  Cookies.remove(\"CompanyCode\");\n                  Cookies.remove(\"profile_pic\");\n                  Cookies.remove(\"first_name\");\n                  Cookies.remove(\"last_name\");\n                  api.defaults.headers.Authorization = \"\";\n                  Router.push(\"/Management\");\n                });\n\n              case 7:\n                //  const { data: data } = await api.post(\"jwt-auth/v1/token/validate\");\n                if (data) {\n                  console.log(\"old token is valid\");\n                  setUser({\n                    user_nicename: Cookies.get(\"user_nicename\"),\n                    user_email: Cookies.get(\"user_email\"),\n                    UserType: Cookies.get(\"UserType\"),\n                    CompanyCode: Cookies.get(\"CompanyCode\"),\n                    BracnhCode: Cookies.get(\"BracnhCode\"),\n                    profile_pic: Cookies.get(\"profile_pic\"),\n                    first_name: Cookies.get(\"first_name\"),\n                    last_name: Cookies.get(\"last_name\")\n                  });\n                } else {}\n\n              case 8:\n                setLoading(false);\n\n              case 9:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      }));\n      return _loadUserFromCookies.apply(this, arguments);\n    }\n\n    loadUserFromCookies();\n  }, []);\n\n  var Sendcond = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(phone) {\n      var tempres;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return api.get(\"rabwa/getUserCode?phone=\" + phone, {});\n\n            case 2:\n              tempres = _context2.sent;\n              return _context2.abrupt(\"return\", tempres);\n\n            case 4:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function Sendcond(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var phoneLogin = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(phone, code) {\n      var _yield$api$get, data;\n\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              _context3.next = 2;\n              return api.get(\"rabwa/singUserIN?phone=\" + phone + \"&code=\" + code, {});\n\n            case 2:\n              _yield$api$get = _context3.sent;\n              data = _yield$api$get.data;\n\n              if (!data) {\n                _context3.next = 23;\n                break;\n              }\n\n              console.log(data);\n              console.log(\"Got new token\" + data.token);\n              Cookies.set(\"token\", data.token, {\n                expires: 60\n              });\n              Cookies.set(\"user_nicename\", data.user_nicename, {\n                expires: 60\n              });\n              Cookies.set(\"user_email\", data.user_email, {\n                expires: 60\n              });\n              Cookies.set(\"UserType\", data.UserType, {\n                expires: 60\n              });\n              Cookies.set(\"BracnhCode\", data.BracnhCode, {\n                expires: 60\n              });\n              Cookies.set(\"CompanyCode\", data.CompanyCode, {\n                expires: 60\n              });\n              Cookies.set(\"profile_pic\", data.profile_pic, {\n                expires: 60\n              });\n              Cookies.set(\"first_name\", data.first_name, {\n                expires: 60\n              });\n              Cookies.set(\"last_name\", data.last_name, {\n                expires: 60\n              });\n              api.defaults.headers.Authorization = \"Bearer \".concat(data.token);\n              setUser({\n                user_nicename: data.user_nicename,\n                user_email: data.user_email,\n                UserType: data.UserType,\n                CompanyCode: data.CompanyCode,\n                BracnhCode: data.BracnhCode,\n                profile_pic: data.profile_pic,\n                first_name: data.first_name,\n                last_name: data.last_name\n              });\n              console.log(\"Got user\", user);\n\n              if (data.UserType == \"Company\") {\n                Router.push(\"/CompanyStatistics\"); //return \"Company\";\n              } else if (data.UserType == \"mandobe\") {\n                // return \"Company\";\n                Router.push(\"/MyUsers\");\n              }\n\n              return _context3.abrupt(\"return\", true);\n\n            case 23:\n              return _context3.abrupt(\"return\", false);\n\n            case 24:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3);\n    }));\n\n    return function phoneLogin(_x2, _x3) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var login = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(username, password) {\n      var _yield$api$post, data;\n\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              _context4.next = 2;\n              return api.post(\"jwt-auth/v1/token\", {\n                username: username,\n                password: password\n              });\n\n            case 2:\n              _yield$api$post = _context4.sent;\n              data = _yield$api$post.data;\n\n              if (!data) {\n                _context4.next = 22;\n                break;\n              }\n\n              console.log(data);\n              console.log(\"Got new token\" + data.token);\n              Cookies.set(\"token\", data.token, {\n                expires: 60\n              });\n              Cookies.set(\"user_nicename\", data.user_nicename, {\n                expires: 60\n              });\n              Cookies.set(\"user_email\", data.user_email, {\n                expires: 60\n              });\n              Cookies.set(\"UserType\", data.UserType, {\n                expires: 60\n              });\n              Cookies.set(\"BracnhCode\", data.BracnhCode, {\n                expires: 60\n              });\n              Cookies.set(\"CompanyCode\", data.CompanyCode, {\n                expires: 60\n              });\n              Cookies.set(\"profile_pic\", data.profile_pic, {\n                expires: 60\n              });\n              Cookies.set(\"first_name\", data.first_name, {\n                expires: 60\n              });\n              Cookies.set(\"last_name\", data.last_name, {\n                expires: 60\n              });\n              api.defaults.headers.Authorization = \"Bearer \".concat(data.token);\n              setUser({\n                user_nicename: data.user_nicename,\n                user_email: data.user_email,\n                UserType: data.UserType,\n                CompanyCode: data.CompanyCode,\n                BracnhCode: data.BracnhCode,\n                profile_pic: data.profile_pic,\n                first_name: data.first_name,\n                last_name: data.last_name\n              });\n              console.log(\"Got user\", user);\n              return _context4.abrupt(\"return\", true);\n\n            case 22:\n              return _context4.abrupt(\"return\", false);\n\n            case 23:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n\n    return function login(_x4, _x5) {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  var logout = function logout() {\n    Cookies.remove(\"token\");\n    Cookies.remove(\"user_nicename\");\n    Cookies.remove(\"user_email\");\n    Cookies.remove(\"UserType\");\n    Cookies.remove(\"BracnhCode\");\n    Cookies.remove(\"CompanyCode\");\n    Cookies.remove(\"profile_pic\");\n    Cookies.remove(\"first_name\");\n    Cookies.remove(\"last_name\");\n    api.defaults.headers.Authorization = \"\";\n    setUser(null);\n  };\n\n  return __jsx(AuthContext.Provider, {\n    value: (_ref5 = {\n      isAuthenticated: !!user,\n      user: user,\n      login: login,\n      logout: logout,\n      Sendcond: Sendcond,\n      phoneLogin: phoneLogin,\n      loading: loading\n    }, _defineProperty(_ref5, \"logout\", logout), _defineProperty(_ref5, \"toggler\", toggler), _defineProperty(_ref5, \"settoggler\", settoggler), _ref5)\n  }, children);\n};\nexport default function useAuth() {\n  var context = useContext(AuthContext);\n  return context;\n}\nexport function ProtectRoute(Component) {\n  var _arguments = arguments;\n  return function () {\n    var _useAuth = useAuth(),\n        user = _useAuth.user,\n        isAuthenticated = _useAuth.isAuthenticated,\n        loading = _useAuth.loading;\n\n    var router = useRouter();\n    useEffect(function () {\n      if (!isAuthenticated && !loading) {\n        Router.push(\"/Management\");\n      } else if (isAuthenticated) {\n        if (user.UserType != \"admin\") Router.push(\"/\");\n      }\n    }, [loading, isAuthenticated]);\n    return __jsx(Component, _arguments);\n  };\n}\nexport function ProtectRouteCompany(Component) {\n  var _arguments2 = arguments;\n  return function () {\n    var _useAuth2 = useAuth(),\n        user = _useAuth2.user,\n        isAuthenticated = _useAuth2.isAuthenticated,\n        loading = _useAuth2.loading;\n\n    var router = useRouter();\n    useEffect(function () {\n      if (!isAuthenticated && !loading) {\n        Router.push(\"/login\");\n      } else if (isAuthenticated) {\n        if (user.UserType != \"Company\") Router.push(\"/\");\n      }\n    }, [loading, isAuthenticated]);\n    return __jsx(Component, _arguments2);\n  };\n}\nexport function ProtectRouteMandobe(Component) {\n  var _arguments3 = arguments;\n  return function () {\n    var _useAuth3 = useAuth(),\n        user = _useAuth3.user,\n        isAuthenticated = _useAuth3.isAuthenticated,\n        loading = _useAuth3.loading;\n\n    var router = useRouter();\n    useEffect(function () {\n      if (!isAuthenticated && !loading) {\n        Router.push(\"/login\");\n      } else if (isAuthenticated) {\n        if (user.UserType != \"mandobe\") Router.push(\"/\");\n      }\n    }, [loading, isAuthenticated]);\n    return __jsx(Component, _arguments3);\n  };\n}","map":null,"metadata":{},"sourceType":"module"}